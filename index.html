// --- UTILIDADES -----------------------------------------------------

function mod(n, m) {
    return ((n % m) + m) % m;
}

function gcd(a, b) {
    while (b) {
        let t = b;
        b = a % b;
        a = t;
    }
    return a;
}

function inversoModular(a, m) {
    a = mod(a, m);
    for (let x = 1; x < m; x++) {
        if (mod(a * x, m) === 1) return x;
    }
    return null;
}

function ajustarDeterminante(det) {
    // Busca el siguiente número coprimo con 27
    for (let i = 0; i < 27; i++) {
        let nuevo = mod(det + i, 27);
        if (gcd(nuevo, 27) === 1) return nuevo;
    }
    return 1;
}

// --- MATRIZ INVERSA -------------------------------------------------

function inversaMatriz2x2(a, b, c, d) {
    let det = a * d - b * c;
    det = mod(det, 27);

    // Si el determinante NO tiene inversa, lo ajustamos
    let invDet = inversoModular(det, 27);
    if (!invDet) {
        let corregido = ajustarDeterminante(det);
        invDet = inversoModular(corregido, 27);
    }

    // Matriz adjunta
    let a2 = mod(d * invDet, 27);
    let b2 = mod(-b * invDet, 27);
    let c2 = mod(-c * invDet, 27);
    let d2 = mod(a * invDet, 27);

    return [a2, b2, c2, d2];
}

// --- TEXTO A NÚMEROS ------------------------------------------------

function textoAMatriz(texto) {
    let valores = [];
    texto = texto.toLowerCase().replace(/ñ/g, "n");

    for (let char of texto) {
        if (char >= "a" && char <= "z") {
            valores.push(char.charCodeAt(0) - 97);
        } else {
            valores.push(26); // espacio
        }
    }

    if (valores.length % 2 !== 0) valores.push(26);
    return valores;
}

// --- MATRIZ A TEXTO -------------------------------------------------

function matrizATexto(arr) {
    return arr.map(v => {
        if (v === 26) return " ";
        return String.fromCharCode(v + 97);
    }).join("");
}

// --- ENCRIPTAR ------------------------------------------------------

document.getElementById("encriptar").addEventListener("click", () => {
    const msg = document.getElementById("mensaje").value;
    let valores = textoAMatriz(msg);

    let a = parseInt(k11.value), b = parseInt(k12.value);
    let c = parseInt(k21.value), d = parseInt(k22.value);

    let res = [];

    for (let i = 0; i < valores.length; i += 2) {
        let x = valores[i];
        let y = valores[i + 1];

        let r1 = mod(a * x + b * y, 27);
        let r2 = mod(c * x + d * y, 27);

        res.push(r1, r2);
    }

    document.getElementById("resultado").textContent = res.join(" ");
});

// --- DESENCRIPTAR ------------------------------------------------------

document.getElementById("desencriptar").addEventListener("click", () => {
    let valores = document.getElementById("resultado").textContent.trim().split(" ").map(Number);

    let a = parseInt(k11.value), b = parseInt(k12.value);
    let c = parseInt(k21.value), d = parseInt(k22.value);

    let inv = inversaMatriz2x2(a, b, c, d);

    let res = [];

    for (let i = 0; i < valores.length; i += 2) {
        let x = valores[i];
        let y = valores[i + 1];

        let r1 = mod(inv[0] * x + inv[1] * y, 27);
        let r2 = mod(inv[2] * x + inv[3] * y, 27);

        res.push(r1, r2);
    }

    document.getElementById("resultadoDes").textContent = matrizATexto(res);
});

